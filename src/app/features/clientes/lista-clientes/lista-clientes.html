<div class="lista-clientes-container">
  <div class="header">
    <h2>Clientes</h2>
    <button mat-raised-button color="primary" (click)="nuevoCliente()">
      <mat-icon>add</mat-icon>
      Nuevo Cliente
    </button>
  </div>

  @if (loading()) {
  <app-loading message="Cargando clientes..." />
  } @else if (error()) {
  <app-error-message [title]="'Error al cargar clientes'" [message]="error()!" (retry)="onRetry()" />
  } @else {
  <div class="table-container">
    <!-- Barra de búsqueda -->
    <mat-form-field class="search-field" appearance="outline">
      <mat-label>Buscar clientes</mat-label>
      <input matInput placeholder="Nombre, código, teléfono o barrio" (input)="onSearch($event)" [value]="searchTerm()">
      <mat-icon matPrefix>search</mat-icon>
    </mat-form-field>

    <!-- Tabla -->
    <table mat-table [dataSource]="sortedData()" matSort (matSortChange)="onSort($event)" class="clientes-table">

      <!-- Columna Código -->
      <ng-container matColumnDef="codigo">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Código</th>
        <td mat-cell *matCellDef="let cliente">{{ cliente.codigo || '-' }}</td>
      </ng-container>

      <!-- Columna Nombre -->
      <ng-container matColumnDef="nombre">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Nombre</th>
        <td mat-cell *matCellDef="let cliente">
          <strong>{{ cliente.nombre }}</strong>
        </td>
      </ng-container>

      <!-- Columna Teléfono -->
      <ng-container matColumnDef="telefono">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Teléfono</th>
        <td mat-cell *matCellDef="let cliente">
          {{ cliente.telefono || '-' }}
        </td>
      </ng-container>

      <!-- Columna Barrio -->
      <ng-container matColumnDef="barrio">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Barrio</th>
        <td mat-cell *matCellDef="let cliente">{{ cliente.barrio || '-' }}</td>
      </ng-container>

      <!-- Columna Ruta -->
      <ng-container matColumnDef="ruta">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Ruta</th>
        <td mat-cell *matCellDef="let cliente">
          @if (cliente.ruta) {
          <mat-chip class="ruta-chip">{{ cliente.ruta }}</mat-chip>
          } @else {
          <span class="sin-ruta">Sin asignar</span>
          }
        </td>
      </ng-container>

      <!-- Columna Tipo Tarifa -->
      <ng-container matColumnDef="tipoTarifa">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Tipo Tarifa</th>
        <td mat-cell *matCellDef="let cliente">
          <mat-chip [class.tarifa-0d]="cliente.tipoTarifa === 'PRECIO_0D'"
            [class.tarifa-5d]="cliente.tipoTarifa === 'PRECIO_5D'"
            [class.tarifa-10d]="cliente.tipoTarifa === 'PRECIO_10D'"
            [class.tarifa-es]="cliente.tipoTarifa === 'PRECIO_ES'"
            [class.tarifa-jm]="cliente.tipoTarifa === 'PRECIO_JM'"
            [class.tarifa-cr]="cliente.tipoTarifa === 'PRECIO_CR'">
            {{ getTarifaLabel(cliente.tipoTarifa) }}
          </mat-chip>
        </td>
      </ng-container>

      <!-- Columna Estado -->
      <ng-container matColumnDef="estado">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Estado</th>
        <td mat-cell *matCellDef="let cliente">
          <mat-chip [class.estado-activo]="cliente.estado === 'ACTIVO'"
            [class.estado-inactivo]="cliente.estado === 'INACTIVO'">
            {{ cliente.estado }}
          </mat-chip>
        </td>
      </ng-container>

      <!-- Columna Acciones -->
      <ng-container matColumnDef="acciones">
        <th mat-header-cell *matHeaderCellDef>Acciones</th>
        <td mat-cell *matCellDef="let cliente">
          <button mat-icon-button [matMenuTriggerFor]="menu" [matTooltip]="'Opciones'">
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #menu="matMenu">
            <button mat-menu-item (click)="verDetalle(cliente)">
              <mat-icon>visibility</mat-icon>
              <span>Ver Detalle</span>
            </button>
            <button mat-menu-item (click)="editarCliente(cliente)">
              <mat-icon>edit</mat-icon>
              <span>Editar</span>
            </button>
            <button mat-menu-item (click)="desactivarCliente(cliente)" [disabled]="cliente.estado === 'INACTIVO'">
              <mat-icon>block</mat-icon>
              <span>Desactivar</span>
            </button>
          </mat-menu>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="table-row" (click)="verDetalle(row)"></tr>
    </table>

    <!-- Paginador -->
    <mat-paginator [length]="totalItems()" [pageSize]="pageSize()" [pageIndex]="pageIndex()"
      [pageSizeOptions]="pageSizeOptions" (page)="onPageChange($event)" showFirstLastButtons>
    </mat-paginator>

    <!-- Mensaje cuando no hay datos -->
    @if (clientes().length === 0) {
    <div class="no-data">
      <mat-icon>people</mat-icon>
      <p>No se encontraron clientes</p>
      @if (searchTerm()) {
      <p class="hint">Intenta con otros términos de búsqueda</p>
      }
    </div>
    }
  </div>
  }
</div>