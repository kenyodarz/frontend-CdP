<div class="lista-productos-container">
  <div class="header">
    <h2>Productos</h2>
    <button mat-raised-button color="primary" (click)="nuevoProducto()">
      <mat-icon>add</mat-icon>
      Nuevo Producto
    </button>
  </div>

  @if (loading()) {
    <app-loading message="Cargando productos..." />
  } @else if (error()) {
    <app-error-message 
      [title]="'Error al cargar productos'"
      [message]="error()!"
      (retry)="onRetry()" />
  } @else {
    <div class="table-container">
      <!-- Barra de búsqueda -->
      <mat-form-field class="search-field" appearance="outline">
        <mat-label>Buscar productos</mat-label>
        <input matInput 
               placeholder="Nombre o código" 
               (input)="onSearch($event)"
               [value]="searchTerm()">
        <mat-icon matPrefix>search</mat-icon>
      </mat-form-field>

      <!-- Tabla -->
      <table mat-table 
             [dataSource]="paginatedData()" 
             matSort
             (matSortChange)="onSort($event)"
             class="productos-table">

        <!-- Columna Código -->
        <ng-container matColumnDef="codigo">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Código</th>
          <td mat-cell *matCellDef="let producto">{{ producto.codigo || '-' }}</td>
        </ng-container>

        <!-- Columna Nombre -->
        <ng-container matColumnDef="nombre">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Nombre</th>
          <td mat-cell *matCellDef="let producto">
            <strong>{{ producto.nombre }}</strong>
          </td>
        </ng-container>

        <!-- Columna Stock Actual -->
        <ng-container matColumnDef="stockActual">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Stock Actual</th>
          <td mat-cell *matCellDef="let producto">
            <mat-chip [class.stock-bajo]="getStockStatus(producto) === 'bajo'">
              {{ producto.stockActual }}
            </mat-chip>
          </td>
        </ng-container>

        <!-- Columna Stock Mínimo -->
        <ng-container matColumnDef="stockMinimo">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Stock Mínimo</th>
          <td mat-cell *matCellDef="let producto">{{ producto.stockMinimo }}</td>
        </ng-container>

        <!-- Columna Precio Venta -->
        <ng-container matColumnDef="precioVenta">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Precio</th>
          <td mat-cell *matCellDef="let producto">
            {{ producto.precio0D | currency:'COP':'symbol-narrow':'1.0-0' }}
          </td>
        </ng-container>

        <!-- Columna Estado -->
        <ng-container matColumnDef="estado">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Estado</th>
          <td mat-cell *matCellDef="let producto">
            <mat-chip [class.estado-activo]="producto.estado === 'ACTIVO'"
                      [class.estado-inactivo]="producto.estado === 'INACTIVO'">
              {{ producto.estado }}
            </mat-chip>
          </td>
        </ng-container>

        <!-- Columna Acciones -->
        <ng-container matColumnDef="acciones">
          <th mat-header-cell *matHeaderCellDef>Acciones</th>
          <td mat-cell *matCellDef="let producto">
            <button mat-icon-button 
                    [matMenuTriggerFor]="menu"
                    [matTooltip]="'Opciones'">
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #menu="matMenu">
              <button mat-menu-item (click)="verDetalle(producto)">
                <mat-icon>visibility</mat-icon>
                <span>Ver Detalle</span>
              </button>
              <button mat-menu-item (click)="editarProducto(producto)">
                <mat-icon>edit</mat-icon>
                <span>Editar</span>
              </button>
              <button mat-menu-item 
                      (click)="desactivarProducto(producto)"
                      [disabled]="producto.estado === 'INACTIVO'">
                <mat-icon>block</mat-icon>
                <span>Desactivar</span>
              </button>
            </mat-menu>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row 
            *matRowDef="let row; columns: displayedColumns;"
            class="table-row"
            (click)="verDetalle(row)"></tr>
      </table>

      <!-- Paginador -->
      <mat-paginator 
        [length]="totalItems()"
        [pageSize]="pageSize()"
        [pageIndex]="pageIndex()"
        [pageSizeOptions]="pageSizeOptions"
        (page)="onPageChange($event)"
        showFirstLastButtons>
      </mat-paginator>

      <!-- Mensaje cuando no hay datos -->
      @if (filteredData().length === 0) {
        <div class="no-data">
          <mat-icon>inventory_2</mat-icon>
          <p>No se encontraron productos</p>
          @if (searchTerm()) {
            <p class="hint">Intenta con otros términos de búsqueda</p>
          }
        </div>
      }
    </div>
  }
</div>
