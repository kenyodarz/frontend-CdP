<div class="form-producto-container">
  @if (loading()) {
  <app-loading message="Cargando..." />
  } @else if (error()) {
  <app-error-message [title]="'Error'" [message]="error()!" (retry)="onRetry()" />
  } @else {
  <div class="form-header">
    <h2>{{ isEditMode() ? 'Editar Producto' : 'Nuevo Producto' }}</h2>
    <button mat-icon-button (click)="cancelar()" matTooltip="Cerrar">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <form [formGroup]="productoForm" (ngSubmit)="onSubmit()">
    <mat-card>
      <mat-card-header>
        <mat-card-title>Información General</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="form-grid">
          <!-- Código -->
          <mat-form-field appearance="outline">
            <mat-label>Código</mat-label>
            <input matInput formControlName="codigo" placeholder="Ej: PAN001">
            <mat-icon matPrefix>tag</mat-icon>
          </mat-form-field>

          <!-- Nombre -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Nombre *</mat-label>
            <input matInput formControlName="nombre" placeholder="Nombre del producto">
            <mat-icon matPrefix>inventory_2</mat-icon>
            @if (productoForm.get('nombre')?.hasError('required') && productoForm.get('nombre')?.touched) {
            <mat-error>El nombre es requerido</mat-error>
            }
            @if (productoForm.get('nombre')?.hasError('minlength')) {
            <mat-error>Mínimo 3 caracteres</mat-error>
            }
          </mat-form-field>

          <!-- Descripción -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Descripción</mat-label>
            <textarea matInput formControlName="descripcion" rows="3" placeholder="Descripción del producto"></textarea>
          </mat-form-field>

          <!-- Categoría -->
          <mat-form-field appearance="outline">
            <mat-label>Categoría *</mat-label>
            <mat-select formControlName="idCategoria">
              @for (categoria of categorias(); track categoria.id) {
              <mat-option [value]="categoria.id">{{ categoria.nombre }}</mat-option>
              }
            </mat-select>
            <mat-icon matPrefix>category</mat-icon>
            @if (productoForm.get('idCategoria')?.hasError('required') && productoForm.get('idCategoria')?.touched) {
            <mat-error>La categoría es requerida</mat-error>
            }
          </mat-form-field>

          <!-- Unidad de Medida -->
          <mat-form-field appearance="outline">
            <mat-label>Unidad de Medida *</mat-label>
            <mat-select formControlName="idUnidad">
              @for (unidad of unidadesMedida(); track unidad.id) {
              <mat-option [value]="unidad.id">{{ unidad.nombre }}</mat-option>
              }
            </mat-select>
            <mat-icon matPrefix>straighten</mat-icon>
            @if (productoForm.get('idUnidad')?.hasError('required') && productoForm.get('idUnidad')?.touched) {
            <mat-error>La unidad es requerida</mat-error>
            }
          </mat-form-field>

          <!-- URL de Imagen -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>URL de Imagen</mat-label>
            <input matInput formControlName="imagenUrl" placeholder="https://...">
            <mat-icon matPrefix>image</mat-icon>
          </mat-form-field>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card>
      <mat-card-header>
        <mat-card-title>Inventario</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="form-grid">
          <!-- Stock Actual -->
          <mat-form-field appearance="outline">
            <mat-label>Stock Actual</mat-label>
            <input matInput type="number" formControlName="stockActual" min="0">
            <mat-icon matPrefix>inventory</mat-icon>
          </mat-form-field>

          <!-- Stock Mínimo -->
          <mat-form-field appearance="outline">
            <mat-label>Stock Mínimo *</mat-label>
            <input matInput type="number" formControlName="stockMinimo" min="0">
            <mat-icon matPrefix>warning</mat-icon>
            @if (productoForm.get('stockMinimo')?.hasError('required') && productoForm.get('stockMinimo')?.touched) {
            <mat-error>El stock mínimo es requerido</mat-error>
            }
          </mat-form-field>

          <!-- Stock Máximo -->
          <mat-form-field appearance="outline">
            <mat-label>Stock Máximo</mat-label>
            <input matInput type="number" formControlName="stockMaximo" min="0">
            <mat-icon matPrefix>trending_up</mat-icon>
          </mat-form-field>

          <!-- Requiere Lote -->
          <div class="checkbox-field">
            <mat-checkbox formControlName="requiereLote">
              Requiere Lote
            </mat-checkbox>
          </div>

          <!-- Días de Vida Útil -->
          @if (productoForm.get('requiereLote')?.value) {
          <mat-form-field appearance="outline">
            <mat-label>Días de Vida Útil</mat-label>
            <input matInput type="number" formControlName="diasVidaUtil" min="1">
            <mat-icon matPrefix>calendar_today</mat-icon>
          </mat-form-field>
          }
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card>
      <mat-card-header>
        <mat-card-title>Precios</mat-card-title>
        <mat-card-subtitle>Los precios con descuento (0D, 10D, 5D, ES) se calculan automáticamente</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="form-grid">
          <!-- Precio Base -->
          <mat-form-field appearance="outline">
            <mat-label>Precio Base *</mat-label>
            <input matInput type="number" formControlName="precioBase" min="0" step="100">
            <span matPrefix>$&nbsp;</span>
            <mat-icon matPrefix>payments</mat-icon>
            <mat-hint>Precio completo sin descuento</mat-hint>
            @if (productoForm.get('precioBase')?.hasError('required') && productoForm.get('precioBase')?.touched) {
            <mat-error>El precio base es requerido</mat-error>
            }
            @if (productoForm.get('precioBase')?.hasError('min')) {
            <mat-error>El precio debe ser mayor o igual a 0</mat-error>
            }
          </mat-form-field>

          <!-- Precio Juan Mina (Opcional) -->
          <mat-form-field appearance="outline">
            <mat-label>Precio Juan Mina (Opcional)</mat-label>
            <input matInput type="number" formControlName="precioJM" min="0" step="100">
            <span matPrefix>$&nbsp;</span>
            <mat-icon matPrefix>store</mat-icon>
            <mat-hint>Solo si difiere del precio base</mat-hint>
            @if (productoForm.get('precioJM')?.hasError('min')) {
            <mat-error>El precio debe ser mayor o igual a 0</mat-error>
            }
          </mat-form-field>

          <!-- Precio Carulla (Opcional) -->
          <mat-form-field appearance="outline">
            <mat-label>Precio Carulla (Opcional)</mat-label>
            <input matInput type="number" formControlName="precioCR" min="0" step="100">
            <span matPrefix>$&nbsp;</span>
            <mat-icon matPrefix>shopping_cart</mat-icon>
            <mat-hint>Solo si difiere del precio base</mat-hint>
            @if (productoForm.get('precioCR')?.hasError('min')) {
            <mat-error>El precio debe ser mayor o igual a 0</mat-error>
            }
          </mat-form-field>
        </div>
      </mat-card-content>
    </mat-card>

    <div class="form-actions">
      <button mat-button type="button" (click)="cancelar()">
        Cancelar
      </button>
      <button mat-raised-button color="primary" type="submit" [disabled]="loading()">
        <mat-icon>save</mat-icon>
        {{ isEditMode() ? 'Actualizar' : 'Crear' }} Producto
      </button>
    </div>
  </form>
  }
</div>