<div class="form-producto-container">
  @if (loading()) {
  <app-loading message="Cargando..." />
  } @else if (error()) {
  <app-error-message [title]="'Error'" [message]="error()!" (retry)="onRetry()" />
  } @else {
  <div class="form-header">
    <h2>{{ isEditMode() ? 'Editar Producto' : 'Nuevo Producto' }}</h2>
    <p-button icon="pi pi-times" [rounded]="true" [text]="true" (onClick)="cancelar()" pTooltip="Cerrar" />
  </div>

  <form [formGroup]="productoForm" (ngSubmit)="onSubmit()">
    <p-card header="Información General">
      <div class="form-grid">
        <!-- Código -->
        <div class="field">
          <p-floatLabel>
            <input pInputText id="codigo" formControlName="codigo" />
            <label for="codigo">Código</label>
          </p-floatLabel>
        </div>

        <!-- Nombre -->
        <div class="field full-width">
          <p-floatLabel>
            <input pInputText id="nombre" formControlName="nombre" class="full-width-input" />
            <label for="nombre">Nombre *</label>
          </p-floatLabel>
          @if (productoForm.get('nombre')?.hasError('required') && productoForm.get('nombre')?.touched) {
          <small class="p-error">El nombre es requerido</small>
          }
          @if (productoForm.get('nombre')?.hasError('minlength')) {
          <small class="p-error">Mínimo 3 caracteres</small>
          }
        </div>

        <!-- Descripción -->
        <div class="field full-width">
          <p-floatLabel>
            <textarea pInputTextarea id="descripcion" formControlName="descripcion" rows="3"
              class="full-width-input"></textarea>
            <label for="descripcion">Descripción</label>
          </p-floatLabel>
        </div>

        <!-- Categoría -->
        <div class="field">
          <p-floatLabel>
            <p-select [options]="categorias()" optionLabel="nombre" optionValue="id" formControlName="idCategoria"
              inputId="idCategoria" styleClass="full-width-input" />
            <label for="idCategoria">Categoría *</label>
          </p-floatLabel>
          @if (productoForm.get('idCategoria')?.hasError('required') && productoForm.get('idCategoria')?.touched) {
          <small class="p-error">La categoría es requerida</small>
          }
        </div>

        <!-- Unidad de Medida -->
        <div class="field">
          <p-floatLabel>
            <p-select [options]="unidadesMedida()" optionLabel="nombre" optionValue="id" formControlName="idUnidad"
              inputId="idUnidad" styleClass="full-width-input" />
            <label for="idUnidad">Unidad de Medida *</label>
          </p-floatLabel>
          @if (productoForm.get('idUnidad')?.hasError('required') && productoForm.get('idUnidad')?.touched) {
          <small class="p-error">La unidad es requerida</small>
          }
        </div>

        <!-- Estado -->
        <div class="field">
          <p-floatLabel>
            <p-select [options]="estadosProducto()" optionLabel="label" optionValue="value" formControlName="estado"
              inputId="estado" styleClass="full-width-input" />
            <label for="estado">Estado *</label>
          </p-floatLabel>
        </div>

        <!-- URL de Imagen -->
        <div class="field full-width">
          <p-floatLabel>
            <input pInputText id="imagenUrl" formControlName="imagenUrl" class="full-width-input" />
            <label for="imagenUrl">URL de Imagen</label>
          </p-floatLabel>
        </div>
      </div>
    </p-card>

    <p-card header="Inventario">
      <div class="form-grid">
        <!-- Stock Actual -->
        <div class="field">
          <p-floatLabel>
            <input pInputText type="number" id="stockActual" formControlName="stockActual" min="0" />
            <label for="stockActual">Stock Actual</label>
          </p-floatLabel>
        </div>

        <!-- Stock Mínimo -->
        <div class="field">
          <p-floatLabel>
            <input pInputText type="number" id="stockMinimo" formControlName="stockMinimo" min="0" />
            <label for="stockMinimo">Stock Mínimo *</label>
          </p-floatLabel>
          @if (productoForm.get('stockMinimo')?.hasError('required') && productoForm.get('stockMinimo')?.touched) {
          <small class="p-error">El stock mínimo es requerido</small>
          }
        </div>

        <!-- Stock Máximo -->
        <div class="field">
          <p-floatLabel>
            <input pInputText type="number" id="stockMaximo" formControlName="stockMaximo" min="0" />
            <label for="stockMaximo">Stock Máximo</label>
          </p-floatLabel>
        </div>

        <!-- Requiere Lote -->
        <div class="field-checkbox">
          <p-checkbox formControlName="requiereLote" [binary]="true" inputId="requiereLote" />
          <label for="requiereLote">Requiere Lote</label>
        </div>

        <!-- Días de Vida Útil -->
        @if (productoForm.get('requiereLote')?.value) {
        <div class="field">
          <p-floatLabel>
            <input pInputText type="number" id="diasVidaUtil" formControlName="diasVidaUtil" min="1" />
            <label for="diasVidaUtil">Días de Vida Útil</label>
          </p-floatLabel>
        </div>
        }
      </div>
    </p-card>

    <p-card header="Precios">
      <p class="subtitle">Los precios con descuento (0D, 10D, 5D, ES) se calculan automáticamente</p>
      <br>
      <div class="form-grid">
        <!-- Precio Base -->
        <div class="field">
          <p-floatLabel>
            <input pInputText type="number" id="precioBase" formControlName="precioBase" min="0" step="100" />
            <label for="precioBase">Precio Base *</label>
          </p-floatLabel>
          <small class="hint">Precio completo sin descuento</small>
          @if (productoForm.get('precioBase')?.hasError('required') && productoForm.get('precioBase')?.touched) {
          <small class="p-error">El precio base es requerido</small>
          }
        </div>

        <!-- Precio Juan Mina (Opcional) -->
        <div class="field">
          <p-floatLabel>
            <input pInputText type="number" id="precioJM" formControlName="precioJM" min="0" step="100" />
            <label for="precioJM">Precio Juan Mina (Opcional)</label>
          </p-floatLabel>
          <small class="hint">Solo si difiere del precio base</small>
        </div>

        <!-- Precio Carulla (Opcional) -->
        <div class="field">
          <p-floatLabel>
            <input pInputText type="number" id="precioCR" formControlName="precioCR" min="0" step="100" />
            <label for="precioCR">Precio Carulla (Opcional)</label>
          </p-floatLabel>
          <small class="hint">Solo si difiere del precio base</small>
        </div>
      </div>
    </p-card>

    <div class="form-actions">
      <p-button label="Cancelar" icon="pi pi-times" [text]="true" (onClick)="cancelar()" />
      <p-button label="{{ isEditMode() ? 'Actualizar' : 'Crear' }} Producto" icon="pi pi-save" type="submit"
        [loading]="loading()" />
    </div>
  </form>
  }
  <p-toast />
</div>