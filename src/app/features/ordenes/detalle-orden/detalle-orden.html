<div class="detalle-orden-container">
  @if (loading()) {
  <app-loading message="Cargando orden..." />
  } @else if (error()) {
  <app-error-message [title]="'Error al cargar orden'" [message]="error()!" (retry)="onRetry()" />
  } @else if (orden(); as ord) {
  <div class="header">
    <div class="title-section">
      <p-button icon="pi pi-arrow-left" [rounded]="true" [text]="true" (onClick)="volver()" pTooltip="Volver" />
      <div>
        <h2>Orden {{ ord.numeroOrden }}</h2>
        <p-tag [value]="ord.estado" [severity]="getEstadoSeverity(ord.estado)" />
      </div>
    </div>
    <div class="actions">
      @if (ord.estado === 'PENDIENTE') {
      <p-button label="Iniciar Preparación" icon="pi pi-play" (onClick)="cambiarEstado('EN_PREPARACION')" />
      }
      @if (ord.estado === 'EN_PREPARACION') {
      <p-button label="Marcar como Lista" icon="pi pi-check" (onClick)="cambiarEstado('LISTA')" />
      }
      @if (ord.estado === 'LISTA' && ord.puedeSerDespachada) {
      <p-button label="Despachar" icon="pi pi-truck" (onClick)="cambiarEstado('DESPACHADA')" />
      }
      @if (ord.estado !== 'CANCELADA' && ord.estado !== 'DESPACHADA' && ord.estado !== 'ENTREGADA') {
      <p-button label="Cancelar" icon="pi pi-times" severity="danger" (onClick)="cancelarOrden()" />
      }
    </div>
  </div>

  <div class="content-grid">
    <!-- Información General -->
    <p-card header="Información General">
      <div class="info-grid">
        <div class="info-item">
          <span class="label">Número de Orden:</span>
          <span class="value"><strong>{{ ord.numeroOrden }}</strong></span>
        </div>
        <div class="info-item">
          <span class="label">Fecha:</span>
          <span class="value">{{ ord.fechaOrden | date:'medium' }}</span>
        </div>
        <div class="info-item">
          <span class="label">Cliente:</span>
          <span class="value">{{ ord.clienteNombre }}</span>
        </div>
        <div class="info-item">
          <span class="label">Empleado:</span>
          <span class="value">{{ ord.empleadoNombre }}</span>
        </div>
        @if (ord.fechaEntregaProgramada) {
        <div class="info-item">
          <span class="label">Entrega Programada:</span>
          <span class="value">{{ ord.fechaEntregaProgramada | date:'short' }}</span>
        </div>
        }
        @if (ord.observaciones) {
        <div class="info-item full-width">
          <span class="label">Observaciones:</span>
          <span class="value">{{ ord.observaciones }}</span>
        </div>
        }
      </div>
    </p-card>

    <!-- Productos -->
    <p-card header="Productos ({{ ord.cantidadProductos }})" styleClass="full-width">
      <p-table [value]="ord.detalles" styleClass="p-datatable-sm">
        <ng-template pTemplate="header">
          <tr>
            <th>Producto</th>
            <th>Cantidad</th>
            <th>Precio Unit.</th>
            <th>Subtotal</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-detalle>
          <tr>
            <td>{{ detalle.producto }}</td>
            <td>{{ detalle.cantidad }}</td>
            <td>{{ detalle.precioUnitario | currency:'COP':'symbol-narrow':'1.0-0' }}</td>
            <td><strong>{{ detalle.subtotal | currency:'COP':'symbol-narrow':'1.0-0' }}</strong></td>
          </tr>
        </ng-template>
      </p-table>

      <div class="totales">
        <div class="total-row">
          <span>Subtotal:</span>
          <span>{{ ord.subtotal | currency:'COP':'symbol-narrow':'1.0-0' }}</span>
        </div>
        @if (ord.descuento > 0) {
        <div class="total-row">
          <span>Descuento:</span>
          <span class="descuento">-{{ ord.descuento | currency:'COP':'symbol-narrow':'1.0-0' }}</span>
        </div>
        }
        <div class="total-row total-final">
          <span>Total:</span>
          <span>{{ ord.total | currency:'COP':'symbol-narrow':'1.0-0' }}</span>
        </div>
      </div>
    </p-card>
  </div>
  }
</div>