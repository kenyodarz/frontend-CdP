<div class="detalle-orden-container">
  @if (loading()) {
  <app-loading message="Cargando orden..." />
  } @else if (error()) {
  <app-error-message [title]="'Error al cargar orden'" [message]="error()!" (retry)="onRetry()" />
  } @else if (orden(); as ord) {
  <div class="header">
    <div class="title-section">
      <button mat-icon-button (click)="volver()" matTooltip="Volver">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div>
        <h2>Orden {{ ord.numeroOrden }}</h2>
        <mat-chip [class]="getEstadoClass(ord.estado)">
          {{ ord.estado }}
        </mat-chip>
      </div>
    </div>
    <div class="actions">
      @if (ord.estado === 'PENDIENTE') {
      <button mat-raised-button color="primary" (click)="cambiarEstado('EN_PREPARACION')">
        <mat-icon>play_arrow</mat-icon>
        Iniciar Preparación
      </button>
      }
      @if (ord.estado === 'EN_PREPARACION') {
      <button mat-raised-button color="primary" (click)="cambiarEstado('LISTA')">
        <mat-icon>check</mat-icon>
        Marcar como Lista
      </button>
      }
      @if (ord.estado === 'LISTA' && ord.puedeSerDespachada) {
      <button mat-raised-button color="primary" (click)="cambiarEstado('DESPACHADA')">
        <mat-icon>local_shipping</mat-icon>
        Despachar
      </button>
      }
      @if (ord.estado !== 'CANCELADA' && ord.estado !== 'DESPACHADA') {
      <button mat-raised-button color="warn" (click)="cancelarOrden()">
        <mat-icon>cancel</mat-icon>
        Cancelar
      </button>
      }
    </div>
  </div>

  <div class="content-grid">
    <!-- Información General -->
    <mat-card>
      <mat-card-header>
        <mat-card-title>Información General</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="info-grid">
          <div class="info-item">
            <span class="label">Número de Orden:</span>
            <span class="value"><strong>{{ ord.numeroOrden }}</strong></span>
          </div>
          <div class="info-item">
            <span class="label">Fecha:</span>
            <span class="value">{{ ord.fechaOrden | date:'medium' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Cliente:</span>
            <span class="value">{{ ord.clienteNombre }}</span>
          </div>
          <div class="info-item">
            <span class="label">Empleado:</span>
            <span class="value">{{ ord.empleadoNombre }}</span>
          </div>
          @if (ord.fechaEntregaProgramada) {
          <div class="info-item">
            <span class="label">Entrega Programada:</span>
            <span class="value">{{ ord.fechaEntregaProgramada | date:'short' }}</span>
          </div>
          }
          @if (ord.observaciones) {
          <div class="info-item full-width">
            <span class="label">Observaciones:</span>
            <span class="value">{{ ord.observaciones }}</span>
          </div>
          }
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Productos -->
    <mat-card class="full-width">
      <mat-card-header>
        <mat-card-title>Productos ({{ ord.cantidadProductos }})</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <table mat-table [dataSource]="ord.detalles" class="productos-table">
          <ng-container matColumnDef="producto">
            <th mat-header-cell *matHeaderCellDef>Producto</th>
            <td mat-cell *matCellDef="let detalle">{{ detalle.producto }}</td>
          </ng-container>

          <ng-container matColumnDef="cantidad">
            <th mat-header-cell *matHeaderCellDef>Cantidad</th>
            <td mat-cell *matCellDef="let detalle">{{ detalle.cantidad }}</td>
          </ng-container>

          <ng-container matColumnDef="precioUnitario">
            <th mat-header-cell *matHeaderCellDef>Precio Unit.</th>
            <td mat-cell *matCellDef="let detalle">
              {{ detalle.precioUnitario | currency:'COP':'symbol-narrow':'1.0-0' }}
            </td>
          </ng-container>

          <ng-container matColumnDef="subtotal">
            <th mat-header-cell *matHeaderCellDef>Subtotal</th>
            <td mat-cell *matCellDef="let detalle">
              <strong>{{ detalle.subtotal | currency:'COP':'symbol-narrow':'1.0-0' }}</strong>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>

        <div class="totales">
          <div class="total-row">
            <span>Subtotal:</span>
            <span>{{ ord.subtotal | currency:'COP':'symbol-narrow':'1.0-0' }}</span>
          </div>
          @if (ord.descuento > 0) {
          <div class="total-row">
            <span>Descuento:</span>
            <span class="descuento">-{{ ord.descuento | currency:'COP':'symbol-narrow':'1.0-0' }}</span>
          </div>
          }
          <div class="total-row total-final">
            <span>Total:</span>
            <span>{{ ord.total | currency:'COP':'symbol-narrow':'1.0-0' }}</span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
  }
</div>