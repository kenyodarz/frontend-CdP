<div class="crear-orden-container">
  <p-toast />
  @if (loading()) {
  <app-loading message="Creando orden..." />
  } @else {
  <div class="header">
    <h2>Nueva Orden de Despacho</h2>
    <p-button icon="pi pi-times" [rounded]="true" [text]="true" (onClick)="cancelar()" pTooltip="Cerrar" />
  </div>

  <form [formGroup]="ordenForm" (ngSubmit)="onSubmit()">
    <p-card header="InformaciÃ³n del Cliente">
      <div class="form-grid">
        <div class="field full-width">
          <p-floatLabel>
            <p-select formControlName="idCliente" [options]="clientes()" optionLabel="nombre" optionValue="idCliente"
              [filter]="true" filterBy="nombre" [showClear]="true" styleClass="w-full" inputId="cliente" />
            <label for="cliente">Cliente *</label>
          </p-floatLabel>
        </div>

        <div class="field full-width">
          <p-floatLabel>
            <textarea pTextarea formControlName="observaciones" rows="2" style="width: 100%"
              inputId="observaciones"></textarea>
            <label for="observaciones">Observaciones</label>
          </p-floatLabel>
        </div>
      </div>
    </p-card>
  </form>

  <p-card header="Productos" styleClass="mt-6">
    <!-- Selector de productos -->
    <div class="producto-selector">
      <div class="field producto-field">
        <p-floatLabel>
          <p-select [(ngModel)]="selectedProducto" [options]="productos()" optionLabel="nombre" [filter]="true"
            filterBy="codigo" [showClear]="true" styleClass="w-full" [ngModelOptions]="{standalone: true}"
            inputId="producto" />
          <label for="producto">Buscar producto</label>
        </p-floatLabel>
      </div>

      <div class="field cantidad-field">
        <p-floatLabel>
          <p-inputNumber [(ngModel)]="cantidadProducto" [min]="1" [showButtons]="true" buttonLayout="horizontal"
            inputId="cantidad" [ngModelOptions]="{standalone: true}" spinnerMode="horizontal" [step]="1"
            decrementButtonClass="p-button-secondary" incrementButtonClass="p-button-secondary"
            incrementButtonIcon="pi pi-plus" decrementButtonIcon="pi pi-minus" />
          <label for="cantidad">Cantidad</label>
        </p-floatLabel>
      </div>

      <p-button label="Agregar" icon="pi pi-plus" (onClick)="agregarProducto()"
        [disabled]="!selectedProducto || cantidadProducto < 1" />
    </div>

    <!-- Tabla de productos agregados -->
    @if (productosOrden().length > 0) {
    <p-table [value]="productosOrden()" styleClass="p-datatable-sm mt-4">
      <ng-template pTemplate="header">
        <tr>
          <th>Producto</th>
          <th>Precio Unit.</th>
          <th>Cantidad</th>
          <th>Subtotal</th>
          <th>Acciones</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-item>
        <tr>
          <td>{{ item.nombre }}</td>
          <td>{{ item.precio | currency:'COP':'symbol-narrow':'1.0-0' }}</td>
          <td>
            <p-inputNumber [ngModel]="item.cantidad" [min]="1" [showButtons]="true" buttonLayout="horizontal"
              (onInput)="actualizarCantidad(item.idProducto, $event.value || 0)" spinnerMode="horizontal" [step]="1"
              decrementButtonClass="p-button-secondary p-button-sm"
              incrementButtonClass="p-button-secondary p-button-sm" incrementButtonIcon="pi pi-plus"
              decrementButtonIcon="pi pi-minus" [inputStyle]="{'width': '3rem'}" />
          </td>
          <td><strong>{{ item.subtotal | currency:'COP':'symbol-narrow':'1.0-0' }}</strong></td>
          <td>
            <p-button icon="pi pi-trash" severity="danger" [rounded]="true" [text]="true"
              (onClick)="eliminarProducto(item.idProducto)" />
          </td>
        </tr>
      </ng-template>
    </p-table>

    <div class="total-section">
      <h3>Total: {{ totalOrden() | currency:'COP':'symbol-narrow':'1.0-0' }}</h3>
    </div>
    } @else {
    <div class="no-productos">
      <i class="pi pi-shopping-cart no-data-icon"></i>
      <p>No hay productos agregados</p>
    </div>
    }
  </p-card>

  <div class="form-actions mt-6">
    <p-button label="Cancelar" icon="pi pi-times" [text]="true" (onClick)="cancelar()" />
    <p-button label="Crear Orden" icon="pi pi-save" (onClick)="onSubmit()" [loading]="loading()" />
  </div>
  }
</div>