<div class="productos-vendidos-report">
  @if (loading()) {
  <app-loading message="Cargando productos..." />
  } @else if (error()) {
  <app-error-message [title]="'Error'" [message]="error()!" (retry)="onRetry()" />
  } @else {
  <!-- Controles -->
  <p-card styleClass="controles-card">
    <div class="controles">
      <div class="field">
        <p-floatLabel>
          <p-select [options]="limites" [(ngModel)]="limite" (ngModelChange)="onLimiteChange()" optionLabel="label"
            optionValue="value" inputId="limite" [style]="{'width':'100%'}" />
          <label for="limite">Mostrar Top</label>
        </p-floatLabel>
      </div>

      <p-button label="Exportar" icon="pi pi-download" (click)="exportar()" />
    </div>
  </p-card>

  <!-- Resumen -->
  <div class="resumen-grid">
    <p-card styleClass="stat-card">
      <div class="stat-content">
        <div class="stat-icon ventas">
          <i class="pi pi-shopping-cart"></i>
        </div>
        <div class="stat-info">
          <div class="stat-label">Total Unidades Vendidas</div>
          <div class="stat-value">{{ totalVendido() }}</div>
        </div>
      </div>
    </p-card>

    <p-card styleClass="stat-card">
      <div class="stat-content">
        <div class="stat-icon ingresos">
          <i class="pi pi-dollar"></i>
        </div>
        <div class="stat-info">
          <div class="stat-label">Ingresos Totales</div>
          <div class="stat-value">{{ totalIngresos() | currency:'COP':'symbol-narrow':'1.0-0' }}</div>
        </div>
      </div>
    </p-card>
  </div>

  <!-- Gráfica -->
  <p-card [header]="'Top ' + limite() + ' Productos Más Vendidos'" styleClass="chart-card">
    <div class="chart-container">
      <p-chart type="bar" [data]="barChartData" [options]="barChartOptions" height="400px" />
    </div>
  </p-card>

  <!-- Ranking -->
  <p-card header="Ranking Detallado" styleClass="ranking-card">
    <div class="ranking-list">
      @for (producto of topProductos(); track $index; let i = $index) {
      <div class="ranking-item">
        <div class="ranking-position">
          <span class="position-number">{{ i + 1 }}</span>
        </div>
        <div class="producto-info">
          <div class="producto-nombre">{{ producto.nombre }}</div>
          <div class="producto-codigo">{{ producto.codigo }}</div>
        </div>
        <div class="producto-stats">
          <div class="stat">
            <span class="stat-label">Vendido:</span>
            <span class="stat-value">{{ producto.cantidadVendida }} unidades</span>
          </div>
          <div class="stat">
            <span class="stat-label">Ingresos:</span>
            <span class="stat-value">{{ producto.totalVentas | currency:'COP':'symbol-narrow':'1.0-0' }}</span>
          </div>
        </div>
      </div>
      }
    </div>

    @if (topProductos().length === 0) {
    <div class="no-data">
      <i class="pi pi-inbox"></i>
      <p>No hay datos de ventas disponibles</p>
    </div>
    }
  </p-card>
  }
</div>