<div class="p-4">
  <h1 class="text-3xl font-bold mb-4">Reportes</h1>

  @if (loading()) {
  <app-loading />
  }

  @if (error()) {
  <app-error-message [message]="error()!" (retry)="onRetry()" />
  }

  <p-tabs value="0">
    <p-tablist>
      <p-tab value="0">Overview</p-tab>
      <p-tab value="1">Comparación por Producto</p-tab>
      <p-tab value="2">Productos por Mes</p-tab>
      <p-tab value="3">Búsqueda de Clientes</p-tab>
      <p-tab value="4">Búsqueda de Productos</p-tab>
      <p-tab value="5">Ventas por Tipo de Cliente</p-tab>
      <p-tab value="6">Detalles de Ventas</p-tab>
    </p-tablist>

    <p-tabpanels>
      <!-- Tab 1: Overview -->
      <p-tabpanel value="0">
        <!-- Year Filter -->
        <form [formGroup]="overviewForm" class="mb-4">
          <div class="grid">
            <div class="col-12 md:col-3">
              <p-floatlabel>
                <p-select id="anioOverview" formControlName="anio" [options]="availableYears()"
                  placeholder="Seleccione un año" styleClass="w-full" />
                <label for="anioOverview">Año</label>
              </p-floatlabel>
            </div>
          </div>
        </form>

        @if (dashboardData()) {
        <!-- Resumen Cards -->
        <div class="grid">
          <div class="col-12 md:col-3">
            <p-card>
              <div class="text-center">
                <div class="text-500 font-medium mb-2">Ingresos Totales</div>
                <div class="text-900 font-bold text-xl">{{ dashboardData()!.resumen.ingresos | currency }}
                </div>
              </div>
            </p-card>
          </div>
          <div class="col-12 md:col-3">
            <p-card>
              <div class="text-center">
                <div class="text-500 font-medium mb-2">Ventas</div>
                <div class="text-900 font-bold text-xl">{{ dashboardData()!.resumen.ventas }}
                </div>
              </div>
            </p-card>
          </div>
          <div class="col-12 md:col-3">
            <p-card>
              <div class="text-center">
                <div class="text-500 font-medium mb-2">Ticket Promedio</div>
                <div class="text-900 font-bold text-xl">{{ dashboardData()!.resumen.ticketPromedio | currency }}
                </div>
              </div>
            </p-card>
          </div>
          <div class="col-12 md:col-3">
            <p-card>
              <div class="text-center">
                <div class="text-500 font-medium mb-2">Productos Únicos</div>
                <div class="text-900 font-bold text-xl">{{ dashboardData()!.resumen.productosUnicos }}
                </div>
              </div>
            </p-card>
          </div>

          <!-- Charts -->
          <div class="col-12 md:col-8">
            <p-card header="Ventas Mensuales">
              <p-chart type="line" [data]="ventasMensualesChart" [options]="chartOptions" height="300px" />
            </p-card>
          </div>
          <div class="col-12 md:col-4">
            <p-card header="Ventas por Tipo de Negocio">
              <p-chart type="pie" [data]="ventasTipoClienteChart" height="300px" />
            </p-card>
          </div>

          <!-- Top Productos Table -->
          <div class="col-12">
            <p-card header="Top Productos">
              <p-table [value]="dashboardData()!.topProductos">
                <ng-template pTemplate="header"> <!-- CAMBIO: pTemplate -->
                  <tr>
                    <th>Producto</th>
                    <th>Unidades</th>
                    <th>Ingresos</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-producto> <!-- CAMBIO: pTemplate -->
                  <tr>
                    <td>{{ producto.producto }}</td>
                    <td>{{ producto.unidades }}</td>
                    <td>{{ producto.ingresos | currency }}</td>
                  </tr>
                </ng-template>
              </p-table>
            </p-card>
          </div>
        </div>
        }
      </p-tabpanel>

      <!-- Tab 2: Comparación por Producto -->
      <p-tabpanel value="1">
        <p-card>
          <form [formGroup]="comparacionForm" class="grid">
            <div class="col-12 md:col-6">
              <p-floatlabel>
                <p-select id="producto" formControlName="productoId" [options]="productos()" optionLabel="nombre"
                  optionValue="id" [filter]="true" filterPlaceholder="Buscar producto" styleClass="w-full" />
                <label for="producto">Producto</label>
              </p-floatlabel>
            </div>
            <div class="col-12 md:col-4">
              <p-floatlabel>
                <input pInputText id="anio" formControlName="anio" type="number" class="w-full" />
                <label for="anio">Año</label>
              </p-floatlabel>
            </div>
            <div class="col-12 md:col-2">
              <p-button label="Buscar" (onClick)="cargarComparacion()" styleClass="w-full" />
            </div>
          </form>

          @if (comparacionData()) {
          <div class="mt-4">
            <h3 class="text-xl font-bold mb-3">{{ comparacionData()!.productoNombre }}</h3>

            <div class="grid mb-4">
              <div class="col-12 md:col-4">
                <div class="text-500">Total Unidades</div>
                <div class="text-900 font-bold">{{ comparacionData()!.totalUnidades }}</div>
              </div>
              <div class="col-12 md:col-4">
                <div class="text-500">Total Ingresos</div>
                <div class="text-900 font-bold">{{ comparacionData()!.totalIngresos | currency }}
                </div>
              </div>
              <div class="col-12 md:col-4">
                <div class="text-500">Precio Promedio</div>
                <div class="text-900 font-bold">{{ comparacionData()!.precioPromedio | currency }}
                </div>
              </div>
            </div>

            <p-chart type="line" [data]="comparacionChart" [options]="chartOptions" height="300px" class="mb-4" />

            <p-table [value]="comparacionData()!.meses">
              <ng-template pTemplate="header">
                <tr>
                  <th>Mes</th>
                  <th>Cantidad</th>
                  <th>Ingresos</th>
                  <th>Precio Promedio</th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-mes>
                <tr>
                  <td>{{ mes.mes }}</td>
                  <td>{{ mes.cantidad }}</td>
                  <td>{{ mes.ingresos | currency }}</td>
                  <td>{{ mes.precioPromedio | currency }}</td>
                </tr>
              </ng-template>
            </p-table>
          </div>
          }
        </p-card>
      </p-tabpanel>

      <!-- Tab 3: Productos por Mes -->
      <p-tabpanel value="2">
        <p-card>
          <form [formGroup]="productosMesForm" class="grid">
            <div class="col-12 md:col-10">
              <p-floatlabel>
                <p-select id="mes" formControlName="mes" [options]="mesesDisponibles()" placeholder="Seleccione un mes"
                  styleClass="w-full" />
                <label for="mes">Mes</label>
              </p-floatlabel>
            </div>
            <div class="col-12 md:col-2">
              <p-button label="Buscar" (onClick)="cargarProductosPorMes()" styleClass="w-full" />
            </div>
          </form>

          @if (productosMes().length > 0) {
          <div class="mt-4">
            <p-chart type="bar" [data]="productosMesChart" [options]="chartOptions" height="300px" class="mb-4" />

            <p-table [value]="productosMes()">
              <ng-template pTemplate="header">
                <tr>
                  <th>Producto</th>
                  <th>Unidades</th>
                  <th>Venta Total</th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-producto>
                <tr>
                  <td>{{ producto.producto }}</td>
                  <td>{{ producto.unidades }}</td>
                  <td>{{ producto.ventaTotal | currency }}</td>
                </tr>
              </ng-template>
            </p-table>
          </div>
          }
        </p-card>
      </p-tabpanel>

      <!-- Tab 4: Búsqueda de Clientes -->
      <p-tabpanel value="3">
        <p-card>
          <form [formGroup]="buscarClientesForm" class="grid">
            <div class="col-12 md:col-5">
              <p-floatlabel>
                <p-select id="cliente" formControlName="clienteId" [options]="clientesSelect()" optionLabel="nombre"
                  optionValue="nombre" [filter]="true" filterPlaceholder="Buscar cliente..."
                  placeholder="Seleccione un cliente" styleClass="w-full" [loading]="loadingClientes()" />
                <!-- <label for="cliente">Cliente</label> -->
              </p-floatlabel>
            </div>
            <div class="col-12 md:col-3">
              <p-floatlabel>
                <p-select id="mes" formControlName="mes" [options]="mesesOptions" optionLabel="label"
                  optionValue="value" placeholder="Todos" styleClass="w-full" />
                <!-- <label for="mes">Mes</label> -->
              </p-floatlabel>
            </div>
            <div class="col-12 md:col-2">
              <p-floatlabel>
                <p-select id="anio" formControlName="anio" [options]="aniosOptions()" styleClass="w-full" />
                <!-- <label for="anio">Año</label> -->
              </p-floatlabel>
            </div>
            <div class="col-12 md:col-2">
              <p-button label="Buscar" (onClick)="buscarComprasCliente()" styleClass="w-full"
                [disabled]="!buscarClientesForm.get('clienteId')?.value" />
            </div>
          </form>

          @if (detallesClienteSeleccionado().length > 0) {
          <div class="mt-4">
            <h4 class="text-lg font-bold mb-3">Detalle de Compras - {{
              buscarClientesForm.get('clienteId')?.value
              }}</h4>

            <p-table [value]="detallesClienteSeleccionado()" [tableStyle]="{'min-width': '50rem'}">
              <ng-template pTemplate="header">
                <tr>
                  <th>Fecha</th>
                  <th># Productos</th>
                  <th>Total</th>
                  <th style="width: 10rem">Acciones</th>
                </tr>
              </ng-template>

              <ng-template pTemplate="body" let-detalle>
                <tr>
                  <td>{{ detalle.fecha | date:'dd/MM/yyyy' }}</td>
                  <td>{{ detalle.numProductos }}</td>
                  <td>{{ detalle.total | currency }}</td>
                  <td>
                    <p-button icon="pi pi-eye" label="Ver Detalle" (onClick)="verDetalleOrden(detalle)" severity="info"
                      [text]="true" />
                  </td>
                </tr>
              </ng-template>
            </p-table>
          </div>
          }

          <!-- Dialog para mostrar productos de la orden -->
          <p-dialog [(visible)]="dialogVisible"
            [header]="'Productos de la Orden #' + (ordenSeleccionada()?.idOrden || '')" [modal]="true"
            [style]="{width: '50vw'}" [draggable]="false" [resizable]="false">

            @if (loadingOrdenProductos()) {
            <div class="flex justify-center p-4">
              <p-progressSpinner styleClass="w-4rem h-4rem" />
            </div>
            } @else if (productosOrdenExpandida().length > 0) {
            <p-table [value]="productosOrdenExpandida()">
              <ng-template pTemplate="header">
                <tr>
                  <th>Producto</th>
                  <th>Cantidad</th>
                  <th>Precio Unitario</th>
                  <th>Subtotal</th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-producto>
                <tr>
                  <td>{{ producto.nombreProducto }}</td>
                  <td>{{ producto.cantidad }}</td>
                  <td>{{ producto.precioUnitario | currency }}</td>
                  <td>{{ producto.subtotal | currency }}</td>
                </tr>
              </ng-template>
            </p-table>
            } @else {
            <p class="text-500">No se encontraron productos para esta orden.</p>
            }
          </p-dialog>

        </p-card>
      </p-tabpanel>

      <!-- Tab 5: Búsqueda de Productos -->
      <p-tabpanel value="4">
        <p-card>
          <form [formGroup]="buscarProductosForm" class="grid">
            <div class="col-12 md:col-5">
              <p-floatlabel>
                <input pInputText id="buscarProducto" formControlName="query" placeholder="Buscar producto..."
                  class="w-full" />
                <label for="buscarProducto">Buscar Producto</label>
              </p-floatlabel>
            </div>
            <div class="col-12 md:col-3">
              <p-floatlabel>
                <p-select id="mesProducto" formControlName="mes" [options]="mesesOptions" optionLabel="label"
                  optionValue="value" placeholder="Todos" styleClass="w-full" />
                <label for="mesProducto">Mes</label>
              </p-floatlabel>
            </div>
            <div class="col-12 md:col-2">
              <p-floatlabel>
                <p-select id="anioProducto" formControlName="anio" [options]="aniosOptions()" styleClass="w-full" />
                <label for="anioProducto">Año</label>
              </p-floatlabel>
            </div>
            <div class="col-12 md:col-2">
              <p-button label="Buscar" (onClick)="buscarProductosAction(buscarProductosForm.get('query')?.value || '')"
                styleClass="w-full" />
            </div>
          </form>

          @if (productosResultados().length > 0) {
          <p-table [value]="productosResultados()" class="mt-4">
            <ng-template pTemplate="header">
              <tr>
                <th>Nombre</th>
                <th>Unidades Vendidas</th>
                <th>Ingresos</th>
                <th>Precio Promedio</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-producto>
              <tr>
                <td>{{ producto.nombre }}</td>
                <td>{{ producto.unidadesVendidas }}</td>
                <td>{{ producto.ingresos | currency }}</td>
                <td>{{ producto.precioPromedio | currency }}</td>
              </tr>
            </ng-template>
          </p-table>
          }
        </p-card>
      </p-tabpanel>

      <!-- Tab 5.5: Ventas por Tipo de Cliente -->
      <p-tabpanel value="5">
        <p-card>
          <form [formGroup]="ventasTipoClienteForm" class="grid mb-4">
            <div class="col-12 md:col-3">
              <p-floatlabel>
                <p-select id="mesTipoCliente" formControlName="mes" [options]="mesesOptions"
                  placeholder="Seleccione un mes" styleClass="w-full" />
                <label for="mesTipoCliente">Mes</label>
              </p-floatlabel>
            </div>
            <div class="col-12 md:col-3">
              <p-floatlabel>
                <p-select id="anioTipoCliente" formControlName="anio" [options]="aniosOptions()"
                  placeholder="Seleccione un año" styleClass="w-full" />
                <label for="anioTipoCliente">Año</label>
              </p-floatlabel>
            </div>
            <div class="col-12 md:col-3 flex align-items-end">
              <p-button label="Buscar" icon="pi pi-search" (onClick)="cargarVentasPorTipoCliente()" />
            </div>
          </form>

          @if (ventasPorTipoCliente().length > 0) {
          <div class="grid">
            <!-- Pie Chart -->
            <div class="col-12 md:col-6">
              <h3 class="text-xl font-semibold mb-3">Distribución de Ingresos</h3>
              <p-chart type="pie" [data]="pieChartData" [options]="pieChartOptions" />
            </div>

            <!-- Table -->
            <div class="col-12 md:col-6">
              <h3 class="text-xl font-semibold mb-3">Detalle por Tipo de Cliente</h3>
              <p-table [value]="ventasPorTipoCliente()" [tableStyle]="{'min-width': '30rem'}">
                <ng-template pTemplate="header">
                  <tr>
                    <th>Tipo de Cliente</th>
                    <th>Ventas</th>
                    <th>Ingresos</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-venta>
                  <tr>
                    <td>{{ venta.tipo }}</td>
                    <td>{{ venta.ventas }}</td>
                    <td>{{ venta.ingresos | currency }}</td>
                  </tr>
                </ng-template>
              </p-table>
            </div>
          </div>
          }
        </p-card>
      </p-tabpanel>

      <!-- Tab 6: Detalles de Ventas -->
      <p-tabpanel value="6">
        <p-card>
          <form [formGroup]="detallesVentasForm" class="grid">
            <div class="col-12 md:col-4">
              <p-floatlabel>
                <p-datepicker id="fechaDesde" formControlName="fechaDesde" dateFormat="yy-mm-dd" styleClass="w-full" />
                <label for="fechaDesde">Fecha Desde</label>
              </p-floatlabel>
            </div>
            <div class="col-12 md:col-4">
              <p-floatlabel>
                <p-datepicker id="fechaHasta" formControlName="fechaHasta" dateFormat="yy-mm-dd" styleClass="w-full" />
                <label for="fechaHasta">Fecha Hasta</label>
              </p-floatlabel>
            </div>
            <div class="col-12 md:col-3 flex align-items-end">
              <p-button label="Buscar" icon="pi pi-search" (onClick)="cargarDetallesVentas()" />
            </div>
          </form>

          @if (detallesVentas().length > 0) {
          <p-table [value]="detallesVentas()" class="mt-4" [paginator]="true" [rows]="10">
            <ng-template pTemplate="header">
              <tr>
                <th>Fecha</th>
                <th>Cliente</th>
                <th>Tipo de Negocio</th>
                <th># Productos</th>
                <th>Total</th>
                <th>Acciones</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-detalle>
              <tr>
                <td>{{ detalle.fecha }}</td>
                <td>{{ detalle.cliente }}</td>
                <td>{{ detalle.tipoCliente }}</td>
                <td>{{ detalle.numProductos }}</td>
                <td>{{ detalle.total | currency }}</td>
                <td>
                  <p-button label="Detalle" icon="pi pi-eye" size="small" (onClick)="verDetalleVenta(detalle)" />
                </td>
              </tr>
            </ng-template>
          </p-table>
          }

          <!-- Dialog para mostrar detalle de venta -->
          <p-dialog [(visible)]="detalleVentaDialogVisible"
            [header]="'Detalle de Venta - ' + (ventaSeleccionada()?.cliente || '')" [modal]="true"
            [style]="{width: '50vw'}" [draggable]="false" [resizable]="false">
            @if (ventaSeleccionada()) {
            <div class="grid">
              <div class="col-6">
                <strong>Fecha:</strong> {{ ventaSeleccionada()!.fecha }}
              </div>
              <div class="col-6">
                <strong>Cliente:</strong> {{ ventaSeleccionada()!.cliente }}
              </div>
              <div class="col-6">
                <strong>Tipo de Negocio:</strong> {{ ventaSeleccionada()!.tipoCliente }}
              </div>
              <div class="col-6">
                <strong>Total:</strong> {{ ventaSeleccionada()!.total | currency }}
              </div>
              <div class="col-12 mt-3">
                <strong>Productos:</strong>
              </div>
              <div class="col-12">
                @if (loadingProductosDetalle()) {
                <div class="text-center p-3">
                  <i class="pi pi-spin pi-spinner" style="font-size: 2rem"></i>
                  <p>Cargando productos...</p>
                </div>
                } @else if (productosVentaSeleccionada().length > 0) {
                <p-table [value]="productosVentaSeleccionada()" [tableStyle]="{'min-width': '30rem'}">
                  <ng-template pTemplate="header">
                    <tr>
                      <th>Producto</th>
                      <th>Cantidad</th>
                      <th>Precio Unit.</th>
                      <th>Subtotal</th>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="body" let-producto>
                    <tr>
                      <td>{{ producto.nombreProducto }}</td>
                      <td>{{ producto.cantidad }}</td>
                      <td>{{ producto.precioUnitario | currency }}</td>
                      <td>{{ producto.subtotal | currency }}</td>
                    </tr>
                  </ng-template>
                </p-table>
                }
              </div>
            </div>
            }
          </p-dialog>
        </p-card>
      </p-tabpanel>
    </p-tabpanels>
  </p-tabs>
</div>