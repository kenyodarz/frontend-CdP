<div class="crear-lote-container">
  @if (loading()) {
  <app-loading message="Creando lote..." />
  } @else {
  <div class="header">
    <h2>Nuevo Lote de Inventario</h2>
    <button mat-icon-button (click)="cancelar()" matTooltip="Cerrar">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <form [formGroup]="loteForm" (ngSubmit)="onSubmit()">
    <mat-card>
      <mat-card-header>
        <mat-card-title>Información del Lote</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="form-grid">
          <!-- Producto -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Producto *</mat-label>
            <mat-select formControlName="idProducto">
              @for (producto of productos(); track producto.idProducto) {
              <mat-option [value]="producto.idProducto">
                {{ producto.nombre }}
              </mat-option>
              }
            </mat-select>
            <mat-icon matPrefix>inventory_2</mat-icon>
            @if (loteForm.get('idProducto')?.invalid && loteForm.get('idProducto')?.touched) {
            <mat-error>El producto es requerido</mat-error>
            }
          </mat-form-field>

          <!-- Código de Lote -->
          <mat-form-field appearance="outline">
            <mat-label>Código de Lote *</mat-label>
            <input matInput formControlName="codigoLote" placeholder="Ej: LOTE-2024-001">
            <mat-icon matPrefix>qr_code</mat-icon>
            @if (loteForm.get('codigoLote')?.invalid && loteForm.get('codigoLote')?.touched) {
            <mat-error>El código de lote es requerido</mat-error>
            }
          </mat-form-field>

          <!-- Cantidad -->
          <mat-form-field appearance="outline">
            <mat-label>Cantidad *</mat-label>
            <input matInput type="number" formControlName="cantidad" min="1">
            <mat-icon matPrefix>inventory</mat-icon>
            @if (loteForm.get('cantidad')?.invalid && loteForm.get('cantidad')?.touched) {
            <mat-error>
              @if (loteForm.get('cantidad')?.hasError('required')) {
              La cantidad es requerida
              } @else if (loteForm.get('cantidad')?.hasError('min')) {
              La cantidad debe ser mayor a 0
              }
            </mat-error>
            }
          </mat-form-field>

          <!-- Fecha de Elaboración -->
          <mat-form-field appearance="outline">
            <mat-label>Fecha de Elaboración *</mat-label>
            <input matInput [matDatepicker]="pickerElaboracion" formControlName="fechaElaboracion">
            <mat-datepicker-toggle matIconSuffix [for]="pickerElaboracion"></mat-datepicker-toggle>
            <mat-datepicker #pickerElaboracion></mat-datepicker>
            @if (loteForm.get('fechaElaboracion')?.invalid && loteForm.get('fechaElaboracion')?.touched) {
            <mat-error>La fecha de elaboración es requerida</mat-error>
            }
          </mat-form-field>

          <!-- Fecha de Vencimiento -->
          <mat-form-field appearance="outline">
            <mat-label>Fecha de Vencimiento</mat-label>
            <input matInput [matDatepicker]="pickerVencimiento" formControlName="fechaVencimiento">
            <mat-datepicker-toggle matIconSuffix [for]="pickerVencimiento"></mat-datepicker-toggle>
            <mat-datepicker #pickerVencimiento></mat-datepicker>
            <mat-hint>Se calcula automáticamente si el producto tiene días de vida útil</mat-hint>
          </mat-form-field>
        </div>

        <!-- Info adicional -->
        @if (loteForm.get('idProducto')?.value) {
        <div class="info-producto">
          <mat-icon>info</mat-icon>
          <span>
            Producto seleccionado: <strong>{{ getProductoNombre(loteForm.get('idProducto')?.value) }}</strong>
          </span>
        </div>
        }
      </mat-card-content>
    </mat-card>

    <div class="form-actions">
      <button mat-button type="button" (click)="cancelar()">
        Cancelar
      </button>
      <button mat-raised-button color="primary" type="submit" [disabled]="loading()">
        <mat-icon>save</mat-icon>
        Crear Lote
      </button>
    </div>
  </form>
  }
</div>