<div class="crear-lote-container">
  @if (loading()) {
  <app-loading message="Cargando productos..." />
  } @else {
  <div class="form-header">
    <h2>Crear Nuevo Lote</h2>
    <p-button icon="pi pi-times" [rounded]="true" [text]="true" (onClick)="cancelar()" pTooltip="Cerrar" />
  </div>

  <form [formGroup]="loteForm" (ngSubmit)="onSubmit()">
    <p-card header="Información del Lote">
      <div class="form-grid">
        <!-- Producto -->
        <div class="field full-width">
          <p-floatLabel>
            <p-select formControlName="idProducto" [options]="productos()" optionLabel="nombre" optionValue="idProducto"
              [filter]="true" filterBy="nombre" inputId="producto" [style]="{'width':'100%'}" />
            <label for="producto">Producto *</label>
          </p-floatLabel>
          @if (loteForm.get('idProducto')?.invalid && loteForm.get('idProducto')?.touched) {
          <small class="p-error">El producto es requerido</small>
          }
        </div>

        <!-- Código de Lote -->
        <div class="field">
          <p-floatLabel>
            <input pInputText formControlName="codigoLote" id="codigoLote" placeholder="Ej: LOTE-2024-001" />
            <label for="codigoLote">Código de Lote *</label>
          </p-floatLabel>
          @if (loteForm.get('codigoLote')?.invalid && loteForm.get('codigoLote')?.touched) {
          <small class="p-error">El código de lote es requerido</small>
          }
        </div>

        <!-- Cantidad -->
        <div class="field">
          <p-floatLabel>
            <p-inputNumber formControlName="cantidad" inputId="cantidad" [min]="1" [showButtons]="true" />
            <label for="cantidad">Cantidad *</label>
          </p-floatLabel>
          @if (loteForm.get('cantidad')?.invalid && loteForm.get('cantidad')?.touched) {
          <small class="p-error">
            @if (loteForm.get('cantidad')?.hasError('required')) {
            La cantidad es requerida
            } @else if (loteForm.get('cantidad')?.hasError('min')) {
            La cantidad debe ser mayor a 0
            }
          </small>
          }
        </div>

        <!-- Fecha de Elaboración -->
        <div class="field">
          <p-floatLabel>
            <p-datepicker formControlName="fechaElaboracion" inputId="fechaElaboracion" [showIcon]="true"
              dateFormat="yy-mm-dd" />
            <label for="fechaElaboracion">Fecha de Elaboración *</label>
          </p-floatLabel>
          @if (loteForm.get('fechaElaboracion')?.invalid && loteForm.get('fechaElaboracion')?.touched) {
          <small class="p-error">La fecha de elaboración es requerida</small>
          }
        </div>

        <!-- Fecha de Vencimiento -->
        <div class="field">
          <p-floatLabel>
            <p-datepicker formControlName="fechaVencimiento" inputId="fechaVencimiento" [showIcon]="true"
              dateFormat="yy-mm-dd" />
            <label for="fechaVencimiento">Fecha de Vencimiento</label>
          </p-floatLabel>
          <small class="p-hint">Se calcula automáticamente si el producto tiene días de vida útil</small>
        </div>
      </div>

      <!-- Info adicional -->
      @if (loteForm.get('idProducto')?.value) {
      <div class="info-producto">
        <i class="pi pi-info-circle"></i>
        <span>
          Producto seleccionado: <strong>{{ getProductoNombre(loteForm.get('idProducto')?.value) }}</strong>
        </span>
      </div>
      }
    </p-card>

    <div class="form-actions">
      <p-button label="Cancelar" severity="secondary" [text]="true" type="button" (click)="cancelar()" />
      <p-button label="Crear Lote" icon="pi pi-save" type="submit" [disabled]="loading()" />
    </div>
  </form>
  }
</div>