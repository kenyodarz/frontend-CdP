<div class="recalcular-stock-container">
  <p-toast></p-toast>
  <p-confirmDialog></p-confirmDialog>

  <p-card header="Recalcular Stock de Inventario">
    <!-- Recalcular Producto Individual -->
    <div class="recalcular-section">
      <h3>Recalcular Stock de un Producto</h3>
      <p class="description">
        Recalcula el stock de un producto específico desde sus movimientos de entrada y salida.
      </p>

      <div class="producto-selector">
        <label for="producto">Producto:</label>
        <p-autoComplete [(ngModel)]="productoSeleccionado" [suggestions]="productosFiltrados"
          (completeMethod)="buscarProductos($event)" field="nombre" [dropdown]="true" placeholder="Buscar producto..."
          inputId="producto" [style]="{'width': '100%'}">
          <ng-template let-producto pTemplate="item">
            <div class="producto-item">
              <span class="producto-nombre">{{ producto.nombre }}</span>
              <span class="producto-stock">Stock: {{ producto.stockActual }}</span>
            </div>
          </ng-template>
        </p-autoComplete>
      </div>

      <div class="button-group">
        <p-button label="Recalcular Stock" icon="pi pi-calculator" (onClick)="recalcularProducto()"
          [loading]="recalculando" [disabled]="!productoSeleccionado" severity="primary">
        </p-button>
      </div>

      @if (productoSeleccionado && !recalculando) {
      <div class="producto-info">
        <h4>{{ productoSeleccionado.nombre }}</h4>
        <p><strong>Stock Actual:</strong> {{ productoSeleccionado.stockActual }} unidades</p>
        <p><strong>Stock Mínimo:</strong> {{ productoSeleccionado.stockMinimo }} unidades</p>
      </div>
      }
    </div>

    <p-divider></p-divider>

    <!-- Recalcular el Stock por completo -->
    <div class="recalcular-section">
      <h3>Recalcular Todo el Stock</h3>
      <p class="description warning">
        <i class="pi pi-exclamation-triangle"></i>
        Esta operación recalculará el stock de TODOS los productos desde sus movimientos.
        Puede tomar varios minutos dependiendo de la cantidad de productos.
      </p>

      <div class="button-group">
        <p-button label="Recalcular Todo el Stock" icon="pi pi-sync" (onClick)="confirmarRecalcularTodos()"
          [loading]="recalculandoTodos" severity="warn">
        </p-button>
      </div>

      @if (recalculandoTodos) {
      <div class="loading-message">
        <p-progressSpinner></p-progressSpinner>
        <p>Recalculando stock de todos los productos...</p>
      </div>
      }
    </div>
  </p-card>
</div>
