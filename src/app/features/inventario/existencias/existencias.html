<div class="card">
  <div class="card-header">
    <div class="header-content">
      <h2>Existencias en Inventario</h2>
      <p class="subtitle">Productos con stock disponible</p>
    </div>
    <div class="header-actions">
      <button pButton type="button" icon="pi pi-refresh" label="Actualizar" (click)="cargarExistencias()"
        [loading]="loading()" class="p-button-outlined"></button>
      <button pButton type="button" icon="pi pi-file-excel" label="Exportar" (click)="exportExcel()"
        class="p-button-success p-button-outlined"></button>
    </div>
  </div>

  <div class="card-body">
    <p-table [value]="productos()" [loading]="loading()" [paginator]="true" [rows]="20"
      [rowsPerPageOptions]="[10, 20, 50, 100]" [showCurrentPageReport]="true"
      currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} productos"
      [globalFilterFields]="['codigo', 'nombre', 'nombreCategoria']" sortField="stockActual" [sortOrder]="-1"
      styleClass="p-datatable-sm" #dt>
      <ng-template pTemplate="caption">
        <div class="table-header">
          <p-iconfield iconPosition="left">
            <p-inputicon styleClass="pi pi-search" />
            <input pInputText type="text" [value]="searchValue()" (input)="onGlobalFilter(dt, $event)"
              placeholder="Buscar por código, nombre o categoría..." class="search-input" />
          </p-iconfield>
          @if (searchValue()) {
          <button pButton type="button" icon="pi pi-times" class="p-button-text p-button-rounded"
            (click)="clearFilter(dt)" pTooltip="Limpiar búsqueda"></button>
          }
        </div>
      </ng-template>

      <ng-template pTemplate="header">
        <tr>
          <th pSortableColumn="codigo">
            Código
            <p-sortIcon field="codigo"></p-sortIcon>
          </th>
          <th pSortableColumn="nombre">
            Nombre
            <p-sortIcon field="nombre"></p-sortIcon>
          </th>
          <th pSortableColumn="stockActual" class="text-center">
            Stock Actual
            <p-sortIcon field="stockActual"></p-sortIcon>
          </th>
          <th pSortableColumn="stockMinimo" class="text-center">
            Stock Mínimo
            <p-sortIcon field="stockMinimo"></p-sortIcon>
          </th>
          <th pSortableColumn="precioBase" class="text-right">
            Precio Base
            <p-sortIcon field="precioBase"></p-sortIcon>
          </th>
          <th>Unidad</th>
          <th pSortableColumn="nombreCategoria">
            Categoría
            <p-sortIcon field="nombreCategoria"></p-sortIcon>
          </th>
          <th>Estado Stock</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-producto>
        <tr [class.stock-critico]="producto.stockActual <= producto.stockMinimo">
          <td><strong>{{ producto.codigo }}</strong></td>
          <td>{{ producto.nombre }}</td>
          <td class="text-center">
            <span class="stock-value" [class.stock-alto]="producto.stockActual > producto.stockMinimo * 2"
              [class.stock-bajo]="producto.stockActual > producto.stockMinimo && producto.stockActual <= producto.stockMinimo * 2"
              [class.stock-critico]="producto.stockActual <= producto.stockMinimo">
              {{ producto.stockActual }}
            </span>
          </td>
          <td class="text-center text-muted">{{ producto.stockMinimo }}</td>
          <td class="text-right">{{ formatCurrency(producto.precioBase) }}</td>
          <td>{{ producto.abreviaturaUnidad || '-' }}</td>
          <td>
            <span class="categoria-badge">{{ producto.nombreCategoria || 'Sin categoría' }}</span>
          </td>
          <td>
            <p-tag [value]="getStockLabel(producto)" [severity]="getStockSeverity(producto)"></p-tag>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="8" class="text-center empty-message">
            <i class="pi pi-inbox"></i>
            <p>No hay productos con existencias en inventario</p>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="summary">
        <div class="table-summary">
          <strong>Total de productos con stock:</strong> {{ productos().length }}
        </div>
      </ng-template>
    </p-table>
  </div>
</div>