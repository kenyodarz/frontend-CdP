<div class="registrar-entrada-container">
  @if (loading()) {
  <app-loading message="Procesando..." />
  } @else if (error()) {
  <app-error-message [title]="'Error'" [message]="error()!" (retry)="cargarProductos()" />
  } @else {

  <p-toast />

  <div class="header">
    <h2>Registrar Entrada de Inventario</h2>
    <p class="subtitle">Agrega productos a la lista y regístralos todos de una vez</p>
  </div>

  <p-card>
    <div class="add-product-section">
      <h3>Agregar Producto</h3>

      <form [formGroup]="entradaForm">
        <div class="form-grid">

          <div class="field">
            <p-floatlabel>
              <p-autocomplete inputId="producto" formControlName="producto" [suggestions]="productosFiltrados()"
                (completeMethod)="filtrarProductos($event)" (onSelect)="onProductoSeleccionado($event)"
                optionLabel="nombre" [dropdown]="true" [forceSelection]="true" placeholder="Buscar producto..."
                styleClass="w-full">
                <ng-template let-producto pTemplate="item">
                  <div class="producto-item">
                    <div class="producto-codigo">{{ producto.codigo }}</div>
                    <div class="producto-nombre">{{ producto.nombre }}</div>
                    <div class="producto-stock">Stock: {{ producto.stockActual }}</div>
                  </div>
                </ng-template>
              </p-autocomplete>
              <label for="producto">Producto *</label>
            </p-floatlabel>
            @if (entradaForm.get('producto')?.invalid && entradaForm.get('producto')?.touched) {
            <small class="p-error">El producto es requerido</small>
            }
          </div>

          <div class="field">
            <p-floatlabel>
              <p-inputnumber inputId="cantidad" formControlName="cantidad" [min]="1" [showButtons]="true"
                buttonLayout="horizontal" incrementButtonIcon="pi pi-plus" decrementButtonIcon="pi pi-minus"
                styleClass="w-full" />
              <label for="cantidad">Cantidad *</label>
            </p-floatlabel>
            @if (entradaForm.get('cantidad')?.invalid && entradaForm.get('cantidad')?.touched) {
            <small class="p-error">La cantidad debe ser mayor a 0</small>
            }
          </div>

          <div class="field">
            <p-floatlabel>
              <input pInputText id="motivo" formControlName="motivo" class="w-full"
                placeholder="Ej: Compra, Producción, Ajuste" />
              <label for="motivo">Motivo *</label>
            </p-floatlabel>
            @if (entradaForm.get('motivo')?.invalid && entradaForm.get('motivo')?.touched) {
            <small class="p-error">El motivo es requerido</small>
            }
          </div>

          @if (mostrarLotes()) {
          <div class="field">
            <p-floatlabel>
              <p-select inputId="codigoLote" formControlName="codigoLote" [options]="lotes()" optionLabel="codigoLote"
                optionValue="codigoLote" placeholder="Seleccionar lote" styleClass="w-full"
                [disabled]="mostrarFormLote()">
                <ng-template let-lote pTemplate="item">
                  <div class="lote-item">
                    <strong>{{ lote.codigoLote }}</strong>
                    <span class="lote-disponible">Disponible: {{ lote.cantidadActual }}</span>
                  </div>
                </ng-template>
              </p-select>
              <label for="codigoLote">Lote *</label>
            </p-floatlabel>
            @if (entradaForm.get('codigoLote')?.invalid && entradaForm.get('codigoLote')?.touched && !mostrarFormLote())
            {
            <small class="p-error">El lote es requerido para este producto</small>
            }

            <div class="lote-actions">
              <p-button [label]="mostrarFormLote() ? 'Usar Lote Existente' : 'Crear Nuevo Lote'"
                [icon]="mostrarFormLote() ? 'pi pi-times' : 'pi pi-plus'" severity="secondary" [outlined]="true"
                size="small" (onClick)="toggleFormLote()" type="button" />
            </div>
          </div>
          }
        </div>

        @if (mostrarFormLote()) {
        <div class="nuevo-lote-section">
          <h4><i class="pi pi-tag"></i> Crear Nuevo Lote</h4>
          <form [formGroup]="loteForm">
            <div class="form-grid-lote">
              <div class="field">
                <p-floatlabel>
                  <input pInputText id="codigoLoteNuevo" formControlName="codigoLote" class="w-full" />
                  <label for="codigoLoteNuevo">Código de Lote *</label>
                </p-floatlabel>
                @if (loteForm.get('codigoLote')?.invalid && loteForm.get('codigoLote')?.touched) {
                <small class="p-error">El código es requerido</small>
                }
              </div>

              <div class="field">
                <p-floatlabel>
                  <input pInputText type="date" id="fechaElaboracion" formControlName="fechaElaboracion"
                    class="w-full" />
                  <label for="fechaElaboracion">Fecha de Elaboración *</label>
                </p-floatlabel>
                @if (loteForm.get('fechaElaboracion')?.invalid && loteForm.get('fechaElaboracion')?.touched) {
                <small class="p-error">La fecha es requerida</small>
                }
              </div>

              <div class="field">
                <p-floatlabel>
                  <p-inputnumber inputId="cantidadLote" formControlName="cantidad" [min]="1" styleClass="w-full" />
                  <label for="cantidadLote">Cantidad *</label>
                </p-floatlabel>
                @if (loteForm.get('cantidad')?.invalid && loteForm.get('cantidad')?.touched) {
                <small class="p-error">La cantidad es requerida</small>
                }
              </div>

              <div class="field">
                <p-floatlabel>
                  <input pInputText type="date" id="fechaVencimiento" formControlName="fechaVencimiento"
                    class="w-full" />
                  <label for="fechaVencimiento">Fecha de Vencimiento</label>
                </p-floatlabel>
              </div>
            </div>
          </form>
          <small class="p-info">
            <i class="pi pi-info-circle"></i>
            El lote se creará automáticamente al agregar el producto
          </small>
        </div>
        }

        <div class="form-actions">
          <p-button label="Agregar a la Lista" icon="pi pi-plus" severity="primary" (onClick)="agregarProducto()"
            type="button" />
        </div>
      </form>
    </div>

    @if (productosEntrada().length > 0) {
    <div class="productos-lista-section">
      <h3>Productos a Registrar ({{ productosEntrada().length }})</h3>

      <p-table [value]="productosEntrada()" styleClass="p-datatable-sm">
        <ng-template pTemplate="header">
          <tr>
            <th>Producto</th>
            <th>Cantidad</th>
            <th>Lote</th>
            <th>Motivo</th>
            <th style="width: 80px">Acciones</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-entrada let-i="rowIndex">
          <tr>
            <td>
              <div class="producto-cell">
                <strong>{{ entrada.producto.codigo }}</strong>
                <span>{{ entrada.producto.nombre }}</span>
              </div>
            </td>
            <td>
              <strong>{{ entrada.cantidad }}</strong> {{ entrada.producto.nombreUnidad }}
            </td>
            <td>
              @if (entrada.crearNuevoLote) {
              <span class="badge-nuevo-lote">
                <i class="pi pi-plus-circle"></i>
                Nuevo: {{ entrada.nuevoLote?.codigoLote }}
              </span>
              } @else if (entrada.lote) {
              {{ entrada.lote.codigoLote }}
              } @else {
              <span class="text-muted">N/A</span>
              }
            </td>
            <td>{{ entrada.motivo }}</td>
            <td>
              <p-button icon="pi pi-trash" severity="danger" [outlined]="true" size="small"
                (onClick)="eliminarProducto(i)" />
            </td>
          </tr>
        </ng-template>
      </p-table>

      <div class="form-actions">
        <p-button label="Cancelar" icon="pi pi-times" severity="secondary" [outlined]="true" (onClick)="onCancel()"
          type="button" />
        <p-button [label]="'Registrar Todas (' + productosEntrada().length + ')'" icon="pi pi-check" severity="success"
          [disabled]="loading()" (onClick)="registrarTodas()" type="button" />
      </div>
    </div>
    }

    @if (productosEntrada().length === 0) {
    <div class="empty-state">
      <i class="pi pi-inbox"></i>
      <p>No hay productos en la lista</p>
      <small>Agrega productos usando el formulario de arriba</small>
    </div>
    }
  </p-card>
  }
</div>